<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PlantLight Pro Dashboard</title>

<style>
:root{
  --bg:#f0f2f5; --card:#fff; --text:#1c1e21; --muted:#65676b;
  --primary:#1877f2; --success:#42b72a; --danger:#fa3e3e;
  --shadow:0 2px 8px rgba(0,0,0,.1);
  --r:12px;
}
body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;}
.container{max-width:600px;margin:0 auto;padding:16px;}

/* å¡ç‰‡æ¨£å¼ */
.card{background:var(--card);border-radius:var(--r);box-shadow:var(--shadow);padding:16px;margin-bottom:16px;}
h2{margin:0 0 12px;font-size:18px;display:flex;align-items:center;gap:8px;}
h2 span{font-size:20px;}

/* é€£ç·šè¨­å®šå€ */
.conn-box{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;align-items:center;}
input{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;box-sizing:border-box;}
button{border:0;border-radius:6px;padding:8px 16px;cursor:pointer;font-weight:bold;transition:0.2s;}
.btn-blue{background:var(--primary);color:#fff;}
.btn-blue:active{opacity:0.8;}
.status-badge{padding:4px 8px;border-radius:99px;font-size:12px;background:#ddd;color:#555;}
.status-badge.ok{background:#e7f3ff;color:var(--primary);}

/* æ„Ÿæ¸¬å™¨å€ */
.sensor-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.sensor-item{background:#f7f8fa;padding:12px;border-radius:8px;display:flex;align-items:center;justify-content:space-between;}
.sensor-val{font-size:20px;font-weight:800;color:var(--primary);}
.sensor-label{font-size:13px;color:var(--muted);}

/* ç‡ˆå…‰æ§åˆ¶å€ */
.slider-group{margin-bottom:16px;}
.slider-header{display:flex;justify-content:space-between;margin-bottom:6px;font-size:14px;font-weight:600;}
input[type=range]{width:100%;cursor:pointer;}
.btn-power{width:100%;padding:12px;background:#222;color:#fff;font-size:16px;border-radius:8px;}

/* ç¹¼é›»å™¨é–‹é—œå€ */
.relay-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.relay-item{background:#fff;border:1px solid #eee;padding:12px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;}
.relay-name{font-weight:600;font-size:15px;}

/* Toggle Switch CSS */
.switch {position: relative;display: inline-block;width: 44px;height: 24px;}
.switch input {opacity: 0;width: 0;height: 0;}
.slider {position: absolute;cursor: pointer;top: 0;left: 0;right: 0;bottom: 0;background-color: #ccc;transition: .4s;border-radius: 24px;}
.slider:before {position: absolute;content: "";height: 18px;width: 18px;left: 3px;bottom: 3px;background-color: white;transition: .4s;border-radius: 50%;}
input:checked + .slider {background-color: var(--success);}
input:checked + .slider:before {transform: translateX(20px);}

/* Debug */
pre{background:#222;color:#0f0;padding:10px;border-radius:8px;font-size:11px;overflow-x:auto;}
</style>
</head>
<body>

<div class="container">
  <div class="card">
    <div class="conn-box">
      <input id="base" value="4125252" placeholder="Topic Base">
      <input id="key" value="9527" type="password" placeholder="Key">
      <button class="btn-blue" id="btnConn">é€£ç·š</button>
    </div>
    <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center;">
      <span class="status-badge" id="status">æœªé€£ç·š</span>
      <small style="color:#888">broker.emqx.io:8084</small>
    </div>
  </div>

  <div class="card">
    <h2><span>ğŸ“Š</span> ç’°å¢ƒç›£æ¸¬</h2>
    <div class="sensor-grid">
      <div class="sensor-item">
        <div><div class="sensor-val" id="t">--</div><div class="sensor-label">æº«åº¦ (Â°C)</div></div>
        <span>ğŸŒ¡</span>
      </div>
      <div class="sensor-item">
        <div><div class="sensor-val" id="h">--</div><div class="sensor-label">æ¿•åº¦ (%)</div></div>
        <span>ğŸ’§</span>
      </div>
      <div class="sensor-item">
        <div><div class="sensor-val" id="co2">--</div><div class="sensor-label">COâ‚‚ (ppm)</div></div>
        <span>â˜ï¸</span>
      </div>
      <div class="sensor-item">
        <div><div class="sensor-val" id="lux">--</div><div class="sensor-label">äº®åº¦ (%)</div></div>
        <span>â˜€ï¸</span>
      </div>
    </div>
  </div>

  <div class="card">
    <h2><span>ğŸ’¡</span> æ¤ç‰©ç‡ˆæ§åˆ¶</h2>
    
    <div class="slider-group">
      <div class="slider-header"><span>äº®åº¦ (Brightness)</span><span id="briVal">50%</span></div>
      <input type="range" id="bri" min="0" max="100" value="50">
    </div>

    <div class="slider-group">
      <div class="slider-header"><span>å…‰è­œ (Spectrum)</span><span id="specVal">1</span></div>
      <input type="range" id="spec" min="1" max="21" value="1">
    </div>

    <button class="btn-power" id="btnPower">ğŸ”Œ é›»æºé–‹é—œ (Toggle)</button>
  </div>

  <div class="card">
    <h2><span>âš™ï¸</span> è¨­å‚™æ§åˆ¶ (ç¹¼é›»å™¨)</h2>
    <div class="relay-grid">
      <div class="relay-item">
        <span class="relay-name">é€²é¢¨æ‰‡</span>
        <label class="switch">
          <input type="checkbox" id="sw_fan_in">
          <span class="slider"></span>
        </label>
      </div>
      <div class="relay-item">
        <span class="relay-name">æ’é¢¨æ‰‡</span>
        <label class="switch">
          <input type="checkbox" id="sw_fan_out">
          <span class="slider"></span>
        </label>
      </div>
      <div class="relay-item">
        <span class="relay-name">æ°´æ³µ</span>
        <label class="switch">
          <input type="checkbox" id="sw_pump">
          <span class="slider"></span>
        </label>
      </div>
      <div class="relay-item">
        <span class="relay-name">è¼”åŠ©/ä¿ç•™</span>
        <label class="switch">
          <input type="checkbox" id="sw_aux">
          <span class="slider"></span>
        </label>
      </div>
    </div>
  </div>

  <div class="card">
    <h2 onclick="document.getElementById('debug').style.display='block'" style="cursor:pointer">ğŸ Debug Info</h2>
    <pre id="debug" style="display:none">Waiting...</pre>
  </div>
</div>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
let client = null;
const $ = (id) => document.getElementById(id);

// è®€å–è¨­å®š
function getTopic(){ return $("base").value.trim(); }
function getKey(){ return $("key").value.trim(); }

// ç™¼é€æŒ‡ä»¤
function pub(op, val){
  if(!client || !client.connected) return;
  const topic = getTopic() + "/cmd";
  const payload = JSON.stringify({ key: getKey(), op: op, v: val });
  client.publish(topic, payload);
  console.log("Sent:", payload);
}

// UI ç¶å®š
$("bri").onchange = (e) => pub("bright_pct", parseInt(e.target.value));
$("bri").oninput = (e) => $("briVal").innerText = e.target.value + "%";

$("spec").onchange = (e) => pub("spec", parseInt(e.target.value));
$("spec").oninput = (e) => $("specVal").innerText = e.target.value;

$("btnPower").onclick = () => pub("power", 1);

// ç¹¼é›»å™¨é–‹é—œç¶å®š (True=1, False=0)
$("sw_fan_in").onchange  = (e) => pub("fan_in", e.target.checked ? 1 : 0);
$("sw_fan_out").onchange = (e) => pub("fan_out", e.target.checked ? 1 : 0);
$("sw_pump").onchange    = (e) => pub("pump", e.target.checked ? 1 : 0);
$("sw_aux").onchange     = (e) => pub("aux", e.target.checked ? 1 : 0);

// MQTT é€£ç·š
$("btnConn").onclick = () => {
  if(client){ client.end(); client = null; }
  
  const statusEl = $("status");
  statusEl.innerText = "é€£ç·šä¸­...";
  statusEl.className = "status-badge";

  const clientId = "web_" + Math.random().toString(16).substr(2, 8);
  const url = "wss://broker.emqx.io:8084/mqtt";

  client = mqtt.connect(url, { clientId: clientId });

  client.on("connect", () => {
    statusEl.innerText = "å·²é€£ç·š";
    statusEl.className = "status-badge ok";
    client.subscribe(getTopic() + "/state");
  });

  client.on("message", (topic, msg) => {
    const str = msg.toString();
    $("debug").innerText = str; // Debug é¡¯ç¤ºåŸå§‹ JSON
    
    try {
      const d = JSON.parse(str);
      
      // æ›´æ–°æ„Ÿæ¸¬å™¨
      if(d.t !== undefined) $("t").innerText = d.t;
      if(d.h !== undefined) $("h").innerText = d.h;
      if(d.co2 !== undefined) $("co2").innerText = d.co2;
      if(d.lux_rel !== undefined) $("lux").innerText = d.lux_rel;

      // æ›´æ–°ç‡ˆå…‰æ‹‰æ¡¿ (å¦‚æœä¸æƒ³è®“ç¶²é è¢«å‹•æ›´æ–°æ»‘æ¡¿ï¼Œå¯è¨»è§£é€™å…©è¡Œ)
      if(d.bri_pct !== undefined) { $("bri").value = d.bri_pct; $("briVal").innerText = d.bri_pct+"%"; }
      if(d.spec !== undefined) { $("spec").value = d.spec; $("specVal").innerText = d.spec; }

      // æ›´æ–°ç¹¼é›»å™¨é–‹é—œç‹€æ…‹ (é‡è¦: è®“ç¶²é ç‹€æ…‹è·Ÿæ—‹éˆ•åŒæ­¥)
      // å‡è¨­ JSON å›å‚³ fan_in: 1 æˆ– 0
      // æ³¨æ„ï¼šé€™è£¡ä¾è³´ä½ åœ¨ ESP32 sendState() è£¡æ·»åŠ äº†å°æ‡‰çš„ key
      // å¦‚æœ ESP32 åªå›å‚³ fan_pct, ä¸‹é¢é€™è¡Œè¦æ”¹
      if(d.fan_in !== undefined) $("sw_fan_in").checked = (d.fan_in > 0);
      else if(d.fan_pct !== undefined) $("sw_fan_in").checked = (d.fan_pct > 0); // ç›¸å®¹èˆŠç‰ˆ key

      if(d.fan_out !== undefined) $("sw_fan_out").checked = (d.fan_out > 0);
      if(d.pump !== undefined) $("sw_pump").checked = (d.pump > 0);
      else if(d.pump_pct !== undefined) $("sw_pump").checked = (d.pump_pct > 0);

      if(d.aux !== undefined) $("sw_aux").checked = (d.aux > 0);

    } catch(e) { console.error(e); }
  });
};
</script>
</body>
</html>
