<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>PlantLight Pro v9.0</title>

<style>
:root {
  --bg: #f4f7fa; --card: #fff; --text: #333;
  --primary: #3b82f6; --success: #22c55e; --purple: #8b5cf6; --red: #ef4444;
  --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
  --r: 12px;
}
body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; -webkit-tap-highlight-color: transparent; }

/* â˜… æ»¿ç‰ˆè¨­å®š */
.container {
  width: 96%; /* å¹¾ä¹ä½”æ»¿å¯¬åº¦ */
  margin: 0 auto;
  padding: 16px 0;
}

/* ç¶²æ ¼ä½ˆå±€ */
.grid-layout {
  display: grid;
  gap: 16px;
  grid-template-columns: 1fr; /* æ‰‹æ©Ÿé è¨­ 1 æ¬„ */
}

/* é›»è…¦ç‰ˆï¼šä¾ç…§è¢å¹•å¯¬åº¦è‡ªå‹•èª¿æ•´æ¬„æ•¸ (Responsive) */
@media (min-width: 768px) { .grid-layout { grid-template-columns: 1fr 1fr; } } /* å¹³æ¿ 2 æ¬„ */
@media (min-width: 1200px) { .grid-layout { grid-template-columns: 1fr 1fr 1fr 1fr; } } /* å¤§è¢å¹• 4 æ¬„ */

/* å¡ç‰‡ */
.card { background: var(--card); border-radius: var(--r); box-shadow: var(--shadow); padding: 20px; }
h2 { margin: 0 0 15px; font-size: 14px; color: #888; text-transform: uppercase; font-weight: 700; display:flex; justify-content:space-between; }

/* é ‚éƒ¨ Header */
header { display: flex; justify-content: space-between; align-items: center; padding: 0 10px 10px; }
h1 { margin: 0; font-size: 24px; color: #111; }
.badge { padding: 5px 10px; border-radius: 99px; font-size: 12px; background: #ddd; color: #666; font-weight: 600; }
.badge.ok { background: #dcfce7; color: #15803d; }

/* é€£ç·šå€ */
.conn-row { display: flex; gap: 8px; margin-bottom: 20px; }
input { padding: 10px; border: 1px solid #ddd; border-radius: 8px; outline: none; flex: 1; }
button { border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600; }
.btn-main { background: var(--primary); color: #fff; }

/* æ„Ÿæ¸¬å™¨ */
.sensor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.s-box { background: #f9fafb; padding: 12px; border-radius: 10px; position: relative; border: 1px solid #eee; }
.s-val { font-size: 24px; font-weight: 800; color: #333; }
.s-label { font-size: 12px; color: #888; }
.s-icon { position: absolute; top: 10px; right: 10px; font-size: 18px; opacity: 0.4; }

/* è¨­å‚™æ§åˆ¶åˆ— */
.dev-row { 
  display: flex; justify-content: space-between; align-items: center; 
  padding: 12px 0; border-bottom: 1px solid #f0f0f0; 
}
.dev-row:last-child { border-bottom: none; }
.dev-left { display: flex; align-items: center; gap: 12px; }
.dev-icon { width: 40px; height: 40px; background: #f3f4f6; border-radius: 8px; display: grid; place-items: center; font-size: 20px; }
.dev-info { display: flex; flex-direction: column; }
.dev-name { font-weight: 700; font-size: 15px; }

/* é‹è¡Œæ™‚é–“èˆ‡å€’æ•¸æ¨™ç±¤ */
.tag-group { display: flex; gap: 6px; margin-top: 4px; }
.run-tag { font-size: 11px; background: #f3e8ff; color: #7e22ce; padding: 2px 6px; border-radius: 4px; display: none; }
.rem-tag { font-size: 11px; background: #fee2e2; color: #b91c1c; padding: 2px 6px; border-radius: 4px; display: none; }

/* æŒ‰éˆ•ç¾¤ */
.btn-timer { background: #eff6ff; color: var(--primary); font-size: 12px; padding: 4px 8px; margin-left: 5px; }
.btn-power { width: 100%; background: #111; color: #fff; margin-top: 10px; }

/* é–‹é—œ */
.switch { position: relative; display: inline-block; width: 46px; height: 26px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .3s; border-radius: 34px; }
.slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
input:checked + .slider { background-color: var(--success); }
input:checked + .slider:before { transform: translateX(20px); }

#debug { display: none; background: #111; color: #0f0; padding: 10px; margin-top: 20px; border-radius: 8px; font-size: 11px; white-space: pre-wrap; }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>ğŸŒ± PlantLight Pro</h1>
    <div id="status" class="badge">æœªé€£ç·š</div>
  </header>

  <div style="padding: 0 10px;">
    <div class="conn-row">
      <input type="text" id="base" value="4125252" placeholder="Topic">
      <input type="password" id="key" value="9527" placeholder="Key">
      <button class="btn-main" id="btnConn">é€£ç·š</button>
    </div>
  </div>

  <div class="grid-layout">
    
    <div class="card">
      <h2>ğŸ“Š ç’°å¢ƒ (Air)</h2>
      <div class="sensor-grid">
        <div class="s-box"><div class="s-val"><span id="t">--</span><small>Â°C</small></div><div class="s-label">æº«åº¦</div><span class="s-icon">ğŸŒ¡</span></div>
        <div class="s-box"><div class="s-val"><span id="h">--</span><small>%</small></div><div class="s-label">æ¿•åº¦</div><span class="s-icon">ğŸ’§</span></div>
        <div class="s-box"><div class="s-val"><span id="co2">--</span></div><div class="s-label">CO2</div><span class="s-icon">â˜ï¸</span></div>
        <div class="s-box"><div class="s-val"><span id="lux">--</span><small>%</small></div><div class="s-label">å…‰ç…§</div><span class="s-icon">â˜€ï¸</span></div>
      </div>
    </div>

    <div class="card">
      <h2>ğŸŒ± åœŸå£¤ (Soil)</h2>
      <div class="sensor-grid">
        <div class="s-box"><div class="s-val"><span id="s_h">--</span><small>%</small></div><div class="s-label">æ¿•åº¦</div><span class="s-icon">ğŸ’§</span></div>
        <div class="s-box"><div class="s-val"><span id="s_t">--</span><small>Â°C</small></div><div class="s-label">æº«åº¦</div><span class="s-icon">ğŸŒ¡</span></div>
        <div class="s-box"><div class="s-val"><span id="s_ph">--</span></div><div class="s-label">PH</div><span class="s-icon">ğŸ§ª</span></div>
        <div class="s-box"><div class="s-val"><span id="s_ec">--</span></div><div class="s-label">EC</div><span class="s-icon">âš¡</span></div>
      </div>
    </div>

    <div class="card" style="grid-column: span 1; min-width: 300px;">
      <h2>âš™ï¸ è¨­å‚™æ§åˆ¶</h2>
      <div id="dev-list"></div> </div>

    <div class="card">
      <h2>ğŸ’¡ ç‡ˆå…‰åƒæ•¸</h2>
      <div style="margin-bottom:15px">
        <div style="display:flex;justify-content:space-between;font-weight:700;margin-bottom:5px"><span>äº®åº¦</span><span id="briVal" style="color:var(--primary)">50%</span></div>
        <input type="range" id="bri" min="0" max="100" value="50" style="width:100%">
      </div>
      <div>
        <div style="display:flex;justify-content:space-between;font-weight:700;margin-bottom:5px"><span>å…‰è­œ</span><span id="specVal" style="color:var(--primary)">1</span></div>
        <input type="range" id="spec" min="1" max="21" value="1" style="width:100%">
      </div>
      <div style="display:flex; gap:10px; margin-top:20px">
        <button onclick="pub('cal_dark',1)" style="flex:1;background:#fff;border:1px solid #ccc;color:#555">æ ¡æ­£æš—å ´</button>
        <button onclick="pub('cal_bright',1)" style="flex:1;background:#fff;border:1px solid #ccc;color:#555">æ ¡æ­£äº®å ´</button>
      </div>
    </div>

  </div> <div style="text-align:center; margin-top:20px">
    <a href="#" onclick="$('debug').style.display='block';return false;" style="color:#aaa;font-size:12px;">Debug Log</a>
    <pre id="debug"></pre>
  </div>
</div>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
let client = null;
const $ = (id) => document.getElementById(id);

// å®šç¾©è¨­å‚™åˆ—è¡¨ (å°æ‡‰ ESP32 çš„ name)
const devices = [
  { id: "light",   name: "æ¤ç‰©ç‡ˆ", icon: "ğŸ’¡" }, // ç‰¹æ®Šè™•ç†
  { id: "mist",    name: "åŠ æ¿•å™¨", icon: "ğŸŒ«" },
  { id: "fan_in",  name: "é€²é¢¨æ‰‡", icon: "ğŸƒ" },
  { id: "fan_out", name: "æ’é¢¨æ‰‡", icon: "ğŸŒª" },
  { id: "pump",    name: "æ°´æ³µ",   icon: "ğŸš°" },
  { id: "aux",     name: "è¼”åŠ©",   icon: "ğŸ”§" }
];

// åˆå§‹åŒ–è¨­å‚™åˆ—è¡¨ UI
const devContainer = $("dev-list");
devices.forEach(d => {
  const html = `
    <div class="dev-row">
      <div class="dev-left">
        <div class="dev-icon">${d.icon}</div>
        <div class="dev-info">
          <div class="dev-name">
            ${d.name} 
            <button class="btn-timer" onclick="setTimer('${d.id}')">â±ï¸</button>
          </div>
          <div class="tag-group">
            <span id="run_${d.id}" class="run-tag">00:00:00</span>
            <span id="rem_${d.id}" class="rem-tag">å‰©é¤˜ 5åˆ†</span>
          </div>
        </div>
      </div>
      <label class="switch">
        <input type="checkbox" id="sw_${d.id}" onchange="toggleDev('${d.id}', this.checked)">
        <span class="slider"></span>
      </label>
    </div>
  `;
  devContainer.insertAdjacentHTML('beforeend', html);
});

function pub(op, val, target=null){
  if(!client || !client.connected) { alert("è«‹å…ˆé€£ç·šï¼"); return; }
  const payload = { key: $("key").value.trim(), op: op, v: val };
  if(target) payload.target = target;
  client.publish($("base").value.trim() + "/cmd", JSON.stringify(payload));
}

function toggleDev(id, checked) {
  // ç‡ˆå…‰é–‹é—œç”¨ power æŒ‡ä»¤ï¼Œå…¶ä»–ç”¨ set æŒ‡ä»¤
  if (id === "light") {
    pub("power", 1); 
    // ç‡ˆå…‰æ˜¯ Toggleï¼Œä½†æˆ‘å€‘ç„¡æ³•ç¢ºçŸ¥ç¡¬é«”ç‹€æ…‹ï¼Œé€™è£¡å‡è¨­åˆ‡æ›æˆåŠŸ
    // å¯¦éš›ç‹€æ…‹æœƒç­‰ MQTT å›å‚³ä¾†æ›´æ–° UI
  } else {
    pub("set", checked ? 1 : 0, id);
  }
}

function setTimer(id) {
  let min = prompt(`è«‹è¼¸å…¥ [${id}] çš„å€’æ•¸æ™‚é–“ (åˆ†é˜)ï¼š`, "10");
  if (min && min > 0) {
    pub("timer", parseInt(min), id);
  } else if (min == "0") {
    pub("timer", 0, id); // å–æ¶ˆå®šæ™‚
  }
}

// æ ¼å¼åŒ–ç§’æ•¸ç‚º HH:MM:SS
function fmtTime(s) {
  if(s <= 0) return "00:00:00";
  const h = Math.floor(s / 3600).toString().padStart(2,'0');
  const m = Math.floor((s % 3600) / 60).toString().padStart(2,'0');
  const sec = (s % 60).toString().padStart(2,'0');
  return `${h}:${m}:${sec}`;
}

// UI ç¶å®š
$("bri").onchange = (e) => pub("bright_pct", parseInt(e.target.value));
$("bri").oninput = (e) => $("briVal").innerText = e.target.value + "%";
$("spec").onchange = (e) => pub("spec", parseInt(e.target.value));
$("spec").oninput = (e) => $("specVal").innerText = e.target.value;

$("btnConn").onclick = () => {
  const btn = $("btnConn"); const badge = $("status");
  if(client){ client.end(); client = null; btn.innerText = "é€£ç·š"; badge.innerText = "æœªé€£ç·š"; badge.className = "badge"; return; }

  btn.innerText = "...";
  client = mqtt.connect("wss://broker.emqx.io:8084/mqtt", { clientId: "web_" + Math.random().toString(16).substr(2, 8) });

  client.on("connect", () => {
    btn.innerText = "æ–·ç·š"; badge.innerText = "å·²é€£ç·š"; badge.className = "badge ok";
    client.subscribe($("base").value.trim() + "/state");
  });

  client.on("message", (topic, msg) => {
    try {
      const d = JSON.parse(msg.toString());
      $("debug").innerText = JSON.stringify(d, null, 2);

      // ç’°å¢ƒ
      if(d.t) $("t").innerText = d.t; if(d.h) $("h").innerText = d.h;
      if(d.co2) $("co2").innerText = d.co2; if(d.lux_rel) $("lux").innerText = d.lux_rel;
      if(d.s_h) $("s_h").innerText = d.s_h; if(d.s_t) $("s_t").innerText = d.s_t;
      if(d.s_ph) $("s_ph").innerText = d.s_ph; if(d.s_ec) $("s_ec").innerText = d.s_ec;
      if(d.bri_pct) { $("bri").value = d.bri_pct; $("briVal").innerText = d.bri_pct+"%"; }
      if(d.spec) { $("spec").value = d.spec; $("specVal").innerText = d.spec; }

      // è¨­å‚™ç‹€æ…‹ (devs ç‰©ä»¶)
      if (d.devs) {
        for (const [key, info] of Object.entries(d.devs)) {
          // 1. æ›´æ–°é–‹é—œ
          const sw = $("sw_" + key);
          if (sw) sw.checked = (info.s === 1);

          // 2. æ›´æ–°é‹è¡Œæ™‚é–“ (ç´«è‰²æ¨™ç±¤)
          const runTag = $("run_" + key);
          if (runTag) {
            if (info.s === 1) {
              runTag.style.display = "inline-block";
              runTag.innerText = "å·²é–‹ " + fmtTime(info.run);
            } else {
              runTag.style.display = "none";
            }
          }

          // 3. æ›´æ–°å€’æ•¸è¨ˆæ™‚ (ç´…è‰²æ¨™ç±¤)
          const remTag = $("rem_" + key);
          if (remTag) {
            if (info.rem > 0) {
              remTag.style.display = "inline-block";
              remTag.innerText = "å‰©é¤˜ " + Math.ceil(info.rem/60) + "åˆ†";
            } else {
              remTag.style.display = "none";
            }
          }
        }
      }

    } catch(e) { console.error(e); }
  });
};
</script>
</body>
</html>
