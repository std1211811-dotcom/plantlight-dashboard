<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PlantLight Dashboard</title>

<style>
  :root{
    --bg:#f6f7f9; --card:#fff; --text:#111; --muted:#666;
    --primary:#2f80ed; --ok:#0a0; --bad:#a00;
    --shadow:0 6px 16px rgba(0,0,0,.08);
    --r:16px;
  }
  body{margin:0;background:var(--bg);color:var(--text);
       font-family:system-ui,-apple-system,"Segoe UI","Noto Sans TC",sans-serif;}
  header{padding:16px 16px 6px; max-width:980px; margin:0 auto;}
  h1{margin:0 0 8px; font-size:22px;}
  .sub{color:var(--muted);font-size:13px}

  .wrap{max-width:980px;margin:0 auto;padding:0 16px 24px;}
  .card{background:var(--card);border-radius:var(--r);box-shadow:var(--shadow);padding:14px;margin:12px 0;}

  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .row > *{flex:1} /* â† ä¿®æ­£ï¼šç§»é™¤ä½ åŸæœ¬å¤šæ‰“çš„ '.'ï¼Œé¿å… CSS è§£ææ€ªæ‰ */

  /* âœ… åªç¸®å¸³è™Ÿ/å¯†ç¢¼æ¬„ä½å¯¬åº¦ï¼Œé¿å…æ“ åˆ°ã€Œç‹€æ…‹ã€ */
  #base{max-width:260px;}
  #key{max-width:140px;}

  button{border:0;border-radius:14px;padding:12px 14px;cursor:pointer;font-weight:700}
  .btn{background:var(--primary);color:#fff}
  .btn2{background:#222;color:#fff}
  .btn3{background:#eee;color:#111}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eee;font-size:12px}
  .ok{color:var(--ok)} .bad{color:var(--bad)}
  .kv{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 0;border-bottom:1px solid #eee}
  .kv:last-child{border-bottom:none}
  .k{display:flex;align-items:center;gap:10px;color:#222;font-weight:700}
  .icon{width:34px;height:34px;border-radius:10px;display:grid;place-items:center;background:#eaf2ff;color:#2f80ed;font-weight:800}
  .v{font-size:22px;font-weight:800}
  .unit{font-size:14px;color:var(--muted);font-weight:700;margin-left:6px}
  input[type=range]{width:100%}
  .sliderLine{display:flex;align-items:center;gap:10px}
  .sliderVal{min-width:76px;text-align:right;font-weight:900;font-size:18px}
  small{color:var(--muted)}
  pre{background:#111;color:#0f0;padding:12px;border-radius:12px;overflow:auto;font-size:12px}

  /* æ‰‹æ©Ÿ/é›»è…¦ç‰ˆé¢åˆ‡æ› */
  .mobile-only{display:none}
  .desktop-only{display:block}
  @media (max-width:768px){
    .mobile-only{display:block}
    .desktop-only{display:none}
  }
  @media (min-width:769px){
    .grid2{display:grid;grid-template-columns:1.1fr .9fr;gap:12px}
    .grid3{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  }
</style>
</head>

<body>
<header>
  <h1>ğŸŒ± PlantLight Dashboard</h1>
  <div class="sub">
    äº®åº¦/å…‰è­œåœ¨æœ€ä¸Šæ–¹ã€‚æ„Ÿæ¸¬è³‡è¨Šèˆ‡å¹«æµ¦/é¢¨æ‰‡æ§åˆ¶åœ¨ä¸‹æ–¹ã€‚<br>
    MQTTï¼š<code>broker.emqx.io</code>ï¼ˆWSS 8084 /mqttï¼‰
  </div>
</header>

<div class="wrap">

  <!-- é€£ç·šè¨­å®š -->
  <div class="card">
    <div class="row">
        <input id="base" value="4125252"
               style="width:100%;padding:10px;border-radius:12px;border:1px solid #ddd">
      </div>

      <div>
        <input id="key" value="9527"
               style="width:100%;padding:10px;border-radius:12px;border:1px solid #ddd">
      </div>

      <div style="flex:0.6">
        <div><b>ç‹€æ…‹</b></div>
        <div class="pill"><span id="conn" class="bad">æœªé€£ç·š</span></div>
      </div>
    </div>

    <div style="margin-top:10px" class="row">
      <button class="btn" id="btnConnect">é€£ç·š / æ–·ç·š</button>
      <button class="btn3" id="btnSetDark">è¨­ç‚ºæš—å ´</button>
      <button class="btn3" id="btnSetBright">è¨­ç‚ºäº®å ´</button>
    </div>
    <small>æš—å ´ï¼šé—œç‡ˆæ™‚çš„ç’°å¢ƒå…‰ï¼›äº®å ´ï¼šæœ€ç™½(21)+æœ€äº®(100%)ã€‚</small>
  </div>

  <!-- ä¸Šæ–¹æ§åˆ¶ï¼šäº®åº¦ & å…‰è­œ -->
  <div class="card">
    <div class="grid2">
      <div>
        <div style="display:flex;justify-content:space-between;align-items:end">
          <div><b>äº®åº¦</b>ï¼ˆ%ï¼‰</div>
          <div class="sliderVal" id="briShow">50%</div>
        </div>
        <div class="sliderLine">
          <input id="bri" type="range" min="0" max="100" value="50">
        </div>
        <small>ç¶²ç«™ç”¨ % æ§åˆ¶ï¼›ESP32 æœƒæ˜ å°„æˆç‡ˆå…·äº®åº¦ç¢¼ 0x17~0x28ã€‚</small>
      </div>

      <div>
        <div style="display:flex;justify-content:space-between;align-items:end">
          <div><b>å…‰è­œ</b>ï¼ˆ1=æœ€ç´…ï¼Œ21=æœ€ç™½ï¼‰</div>
          <div class="sliderVal" id="specShow">1</div>
        </div>
        <div class="sliderLine">
          <input id="spec" type="range" min="1" max="21" value="1">
        </div>
        <small>1 æœ€ç´… â†’ 21 æœ€ç™½ã€‚</small>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn2" id="btnPower">ğŸ”Œ é•·æŒ‰åœ¨ç¡¬é«”ä¸Šï¼›ç¶²é é»é€™è£¡ = é–‹/é—œ</button>
    </div>
  </div>

  <!-- æ„Ÿæ¸¬è³‡è¨Š -->
  <div class="card">
    <div class="kv">
      <div class="k"><span class="icon">ğŸŒ¡</span> æº«åº¦ (Â°C)</div>
      <div class="v"><span id="t">--</span><span class="unit">Â°C</span></div>
    </div>
    <div class="kv">
      <div class="k"><span class="icon">ğŸ’§</span> æ¿•åº¦ (%)</div>
      <div class="v"><span id="h">--</span><span class="unit">%</span></div>
    </div>
    <div class="kv">
      <div class="k"><span class="icon">ğŸŸ¦</span> COâ‚‚ (ppm)</div>
      <div class="v"><span id="co2">--</span><span class="unit">ppm</span></div>
    </div>
    <div class="kv">
      <div class="k"><span class="icon">â˜€</span> ç…§åº¦ï¼ˆç›¸å°ï¼‰</div>
      <div class="v"><span id="luxRel">--</span><span class="unit">%</span></div>
    </div>
    <div class="kv">
      <div class="k"><span class="icon">â•</span> å…‰è£œå„Ÿéœ€æ±‚</div>
      <div class="v"><span id="comp">--</span><span class="unit">%</span></div>
    </div>
    <div class="kv">
      <div class="k"><span class="icon">ğŸŒ±</span> åœŸå£¤æ¿•åº¦</div>
      <div class="v"><span id="soil">--</span><span class="unit">%</span></div>
    </div>
  </div>

  <!-- å¹«æµ¦/é¢¨æ‰‡ PWM æ§åˆ¶ -->
  <div class="card">
    <div class="grid2">
      <div>
        <div style="display:flex;justify-content:space-between;align-items:end">
          <div><b>å¹«æµ¦ PWM</b></div>
          <div class="sliderVal" id="pumpShow">0%</div>
        </div>
        <input id="pump" type="range" min="0" max="100" value="0">
      </div>
      <div>
        <div style="display:flex;justify-content:space-between;align-items:end">
          <div><b>é¢¨æ‰‡ PWM</b></div>
          <div class="sliderVal" id="fanShow">0%</div>
        </div>
        <input id="fan" type="range" min="0" max="100" value="0">
      </div>
    </div>
    <small>å…©è·¯éƒ½èµ° PWMï¼ˆä¹‹å¾Œ ESP32 ç«¯ç”¨ MOSFET/é©…å‹•å™¨è¼¸å‡ºï¼‰ã€‚</small>
  </div>

  <!-- Debug -->
  <div class="card">
    <b>ç‹€æ…‹ JSONï¼ˆMQTT stateï¼‰</b>
    <pre id="state">{}</pre>
  </div>

</div>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
  let client = null;

  const $ = (id) => document.getElementById(id);
  const connEl = $("conn");
  const stateEl = $("state");

  // sliders
  const bri = $("bri"), spec = $("spec"), pump = $("pump"), fan = $("fan");
  const briShow = $("briShow"), specShow = $("specShow"), pumpShow = $("pumpShow"), fanShow = $("fanShow");

  function topicBase(){ return $("base").value.trim(); }
  function key(){ return $("key").value.trim(); }

  function Tcmd(){ return topicBase() + "/cmd"; }
  function Tstate(){ return topicBase() + "/state"; }

  function setConn(ok, text){
    connEl.textContent = text;
    connEl.className = ok ? "ok" : "bad";
  }

  function publish(obj){
    if(!client || !client.connected) return;
    client.publish(Tcmd(), JSON.stringify({key:key(), ...obj}), {qos:0, retain:false});
  }

  // UI å³æ™‚é¡¯ç¤º
  function syncShows(){
    briShow.textContent = bri.value + "%";
    specShow.textContent = spec.value;
    pumpShow.textContent = pump.value + "%";
    fanShow.textContent = fan.value + "%";
  }
  bri.oninput = spec.oninput = pump.oninput = fan.oninput = syncShows;
  syncShows();

  // æ§åˆ¶ï¼šchange æ™‚æ‰é€ï¼Œé¿å…æ‹–æ›³ç‹‚ç™¼
  bri.onchange  = () => publish({op:"bright_pct", v:Number(bri.value)});
  spec.onchange = () => publish({op:"spec", v:Number(spec.value)});
  pump.onchange = () => publish({op:"pump_pct", v:Number(pump.value)});
  fan.onchange  = () => publish({op:"fan_pct", v:Number(fan.value)});

  $("btnPower").onclick = () => publish({op:"power"});
  $("btnSetDark").onclick = () => publish({op:"cal_dark"});
  $("btnSetBright").onclick = () => publish({op:"cal_bright"});

  $("btnConnect").onclick = () => {
    if(client && client.connected){
      client.end(true);
      setConn(false, "å·²ä¸­æ–·");
      return;
    }
    const url = "wss://broker.emqx.io:8084/mqtt";
    client = mqtt.connect(url, {
      clientId: "web_" + Math.random().toString(16).slice(2),
      clean: true,
      reconnectPeriod: 1000,
      connectTimeout: 8000
    });

    setConn(false, "é€£ç·šä¸­...");

    client.on("connect", () => {
      setConn(true, "å·²é€£ç·š");
      client.subscribe([Tstate()], {qos:0});
    });
    client.on("reconnect", () => setConn(false, "é‡é€£ä¸­..."));
    client.on("close", () => setConn(false, "å·²æ–·ç·š"));
    client.on("error", () => setConn(false, "éŒ¯èª¤"));

    client.on("message", (topic, payload) => {
      if(topic !== Tstate()) return;
      const text = payload.toString();
      try{
        const obj = JSON.parse(text);
        stateEl.textContent = JSON.stringify(obj, null, 2);

        if(obj.t != null) $("t").textContent = obj.t;
        if(obj.h != null) $("h").textContent = obj.h;
        if(obj.co2 != null) $("co2").textContent = obj.co2;
        if(obj.lux_rel != null) $("luxRel").textContent = obj.lux_rel;
        if(obj.comp != null) $("comp").textContent = obj.comp;
        if(obj.soil != null) $("soil").textContent = obj.soil;

        if(obj.bri_pct != null){ bri.value = obj.bri_pct; }
        if(obj.spec != null){ spec.value = obj.spec; }
        if(obj.pump_pct != null){ pump.value = obj.pump_pct; }
        if(obj.fan_pct != null){ fan.value = obj.fan_pct; }
        syncShows();
      }catch{
        stateEl.textContent = text;
      }
    });
  };
</script>
</body>
</html>
